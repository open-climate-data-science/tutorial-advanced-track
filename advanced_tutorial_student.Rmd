---
title: "North Carolina State Climate Office "
output:
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#package for plotting 
library(ggplot2)
#package for cleaning data and logical things 
library(tidyverse)


#time series related 
library(forecast)
#install.packages("xts")                      # Install & load xts package
library("xts")
library(TSstudio)


#other packages for kmeans
library(here)
library(tidymodels)
library(ClusterR)
library(cluster)
library(broom)

## allows us to read in large amounts of data
library(data.table)


## Optional PCA
library(corrplot)

```

# OCDS Advanced Track Tutorial Student Version{.tabset}


## Tutorial Learning Goals

Welcome to the NCSCO OCDS Intro track tutorial. We are  [Nick Gawron](https://www.linkedin.com/in/ngawrondata/) and [Livia Popa](https://www.linkedin.com/in/livia-popa-23a018183/), we will be working with you through today's tutorial.  We will be using R studio for today's session. 

We will be tackling these objectives:

- *Define* open data and reproducible science
- *Recognize* the importance of statistical analysis for climate data analysis using cloud based data
- *Apply* techniques to access and explore publicly available climate data from the cloud using exploratory data analysis (i.e. tidyverse)
- *Create* a machine learning model to predicts results for a representative case study

### Meet Mr. Wuf!

Mr. Wuf works for Mount Mitchell State Park in Burnsville, NC and was recently asked by his boss to write a report summarizing rainfall and temperature data for 2021. This report will be used to help optimize 2022 event planning (e.g., fall color viewing) for park visitors and maintenance scheduling for park staff. He recently got promoted to the head office of the NC State Climate office! Mr. Wuf’s wife, Mrs. Wuf, recently told him about the State Climate Office of North Carolina’s new nClimgrid and Econet data portals. He agrees with her that it would be a great opportunity to check out these new, free tools. After some preliminary sleuthing around nClimgrid, he discovered there was a Monthly U.S Climate Gridded Dataset (nClimGrid; https://www.ncei.noaa.gov/access/metadata/landing-page/bin/iso?id=gov.noaa.ncdc:C00332). How did he miss this? Once he downloads these data from nClimGrid and Econet, Mr. Wuf plans to put the skills he learned in an online R programming course to the test for this real-world, work-related project.\

## Importing Data

### API Introduction 

- API is the acronym for Application Programming Interface that enables applications to exchange data and functionality easily and securely.

- The API data that we will be using is called nClimgrid which consists of four climate variables derived from the GHCN-Dataset: maximum temperature, minimum temperature, average temperature, and precipitation. 

### nClimgrid Data Set

- **Blurb on DataSet**

```{r}

## Read in data from AWS nClimGrid 2020-2021

```

```{r}

## Read in nClimGrid 2010-2019


```

```{r}
#If computation time takes a while ... we have   a .Rda file 

```

## Functions/Cleaning

### Combining Data Sets

```{r}
## Lets quickly combind the data sets to get a data set ranging from the above
## lets also filter for data record that pertain to North Carolina

```


```{r}
## Using the whole data set, subset values to only look at the years 2020
## We will be using this data set for k-means clustering later
## Call the data set nclimk _raw
## This data set will have 374 records


```

### Functions

Using the formula $(C \times \frac{9}{5}) + 32=F$, covert the temperature to Fahrenheit. 



```{r}
#create a function for basic syntax 
# convert data value temperature F to C
# Call it CtoF

```

We now will need to apply this function to the temperature columns. 

```{r}
#apply the fucntion  CtoF with tidyverse functions 
# to the coloumns relating to tempurature

```

### Cleaning

```{r}
## Apply Tidyverse piping to easily add degree labels  to the end of certain coloumns for temp
## and to add units for precipitation

```

```{r}
## Keep the weather data coloumns as well as the date, drop all other coloumns 
## Further Create the variable ifRain: a factor to indicate wether it rained on a certain day
## Call this final data set nclimf

```

### Cleaning for nclimk

Below we do the same cleaning and data preparation that we did for nclim, with the exclusion of the ifNC variable. This is because we will be looking at all of the data

```{r}
### below we do the same cleaning for nlcimk 
#apply the ufnction CtoF with tidyverse
nclimk_raw[8:10]<- nclimk_raw[8:10]%>% lapply(CtoF)

## Apply Tidyverse piping to easily add degree labels  to the end of certain coloumns for temp
## and to add units for precipitation
colnames(nclimk_raw)[8:10]<-colnames(nclimk_raw)[8:10]%>%tolower()%>% paste0("_degf")
colnames(nclimk_raw)[7]<-colnames(nclimk_raw)[7]%>%tolower()%>% paste0("_cm")

nclimk <- nclimk_raw %>% select(date,prcp_cm,tavg_degf,tmin_degf,tmax_degf)%>%
                    mutate(ifRain= as.factor(as.integer(prcp_cm>0)))
                    
                           
                           
#viewing the data for k-means
head(nclimk)

```



## EDA


- We will inspect the data through a couple graphs as well as a simple linear regression

```{r}
# scatterplot of avg tempurature vs time, color the points red
## add labels
## save the plot at plotOTemp

```



## Machine Learning 


### Simple Regression 

- *Text Blurb*

```{r}

```

### Time Series Analysis

- A time series is a collection of observations of well-defined data items obtained through repeated measurements over time

- Time series analyze a sequence of data points collected over an interval of times

- We will now try to fit a time series model to this data rather than a regression to see if the results improve. We will create a time series forecast with ARIMA (Auto Regressive Integrated Moving Average).

- First we begin by creating an xts object
```{r}

## with the variables date and average temperature, create a time series object. 
## save as temp_ts

```

- Now we will split the data into a training and testing set. Majority of the data will be in the training set.

```{r}
# train/validation split

```

- Next we plot the time series object we created to take a closer look at the data

```{r}
# plot the time series object we called temp_ts

```

### Time to build the model!

```{r}
# build the time series model

```

- Once the model has been created, we will use that to create a forecasting xts object

```{r}
# plot validation data with forecast on top of plot

```

- Finally we plot the validation (testing) data and layer the forecast on top for our time series model

```{r}
# plot the testing / validation data 
# overlay the time series forecast for this testing data

```




### K-Means Clustering in nClimGridData

#### Creating Functions


- We want to create a function that can do a complicated process in as few steps as possible. 

- `calculate_cluster` is the name of the function we are going to create to compute k-means clusters among other information. 

```{r}

# Our goal is to write a function to compute k-means on a data set
# It may be helpful to look at help of cluster::silhouette
  # More specifically we will want to look at the colnames for the output of silhouette 
# Inputs: data.frame and k number of clusters 
# We want to clean our data by scaling it
# our output will be a data frame, we will call df in the function, with an added shilloute score coloumn



```


```{r}

##plot to the data of average tempurature w.r.t date nclimk


```


```{r}

# data subset nclimk
# change the date to the day of the year!
# select the column of the date and temperature only
# omit any missing values 
# inspect data
nclimk_tocluster <- nclimk %>%
    mutate(doy = yday(date)) %>%
    select(doy, tavg_degf) %>%
    na.omit()
  


head(nclimk_tocluster)

```


- Now we want to set up a data frame to determine which runs 

```{r}
  
# using the map function
# MAP cluster calculations function to range of k values
# This will help us determine the optimal number of clusters k 
  # consider a k range from 2 to 12 clusters
#call this data set temp_cluster_data
# inspect it


```

```{r}
  # calculate average silhouette score (highest for optimal number of k clusters)
  # for each k value
  # store these values for each value of k as temp_sil_score_data

```

```{r}
  # find maximum value for the shil score  from temp_sil_score_data
  # Call this row of the dataframe temp_optimal_sil_score_data
 
  
  # save optimal k from as temp_optimal_k_value 

```
 
 - Note we could have also used a visual inspection
 
```{r}
# plot the data from temp_sil_score_data and visually inspect to determine the k
# with the largest sil score
# Add an additional point to isolate the maximum sil score



```
 
 
 
```{r}
  
  
  # save optimal k cluster data as nclimk_optimal_cluster
  # i.e. consider only the instsances where k in optimal 


```



```{r}
# plot outputs tempavg vs doy
# color each data point by its associated cluster


```



```{r}
# plot outputs density of doy colored by cluster



```



## Bonus (for time) Content!

### PCA from ECOnet Data 

```{r}

# Here we are reading in cardinal data that is provided to us, changing labels 
# and creating an ifRain Variable

cardinal <- read_csv("cardinal_data.csv", 
     col_types = list(`Average Air Temperature (F)` = col_number(), 
         `Maximum Air Temperature (F)` = col_number(), 
         `Minimum Air Temperature (F)` = col_number(), 
         `Average Experimental Leaf Wetness (mV)` = col_number(), 
         `Total Precipitation (in)` = col_number(), 
         `Average Relative Humidity (%)` = col_number(), 
         `Average Soil Moisture (m3/m3)` = col_number(), 
         `Average Soil Temperature (F)` = col_number(), 
         `Average Solar Radiation (W/m2)` = col_number(), 
         `Average Station Pressure (mb)` = col_number()))

cardinal<-drop_na(cardinal)
str(cardinal)
cardinal$Date<-as.Date(cardinal$Date, tryFormats= c("%m/%d/%y"))
view(cardinal)

#changes col names
colnames(cardinal)=c("date","AvgT","MaxT","MinT","AvgLw","Tprep","AvgHum","AvgSm","AvgSt","AvgSr","AvgStp")



cardinal$IfRain<- (cardinal$Tprep>0)
cardinal$IfRain<-as.factor(as.integer(cardinal$IfRain))


```

### Basic Plotting with GGplot 


```{r}

## We present EDA for looking at avergae tempurature w.r.t. date

```

- EDA is how we can motivate future ML models!

- We can use forecasting to extend this trend!


### PCA to cluster rain variable 


- using cardinal data to obsevre *if* there is clustering 

- used for future models

- helps us describe higher dimensional data with **less**


Three general steps: 

  1. Remove heavily correlated columns! 
    - Min Temp and Max Temp for a certain day will correlate with one another!
    
  2. Center Data

Observe: 

```{r}
#using the library corrplot, create a correlation of the numeric


```

- Tells us to remove all but one temperature variable


```{r}
#Drop all heavily correlated variables from the cardinal date
#call this data set cardshot


```


- We will now conduct PCA on our data 


```{r}
## conduct PCA on the cardshot data set with princomp 
## call the output pca_card
## Note we must center the data first and not use a correlation matrix for analysis



```




```{r}
#plot the scores variable from the pca output 
# color the plot by the variable IfRainVar
#add a base R legend


```


- Here we can look at how good PCA does at describing changes in data 

- We see 2 components describes 96% of the data's variation ! (This is very good)

```{r}
#output the summary of the PCA object

```



```{r}
#use the screeplot function on pca_card 
# note we want a plottype with lines


```


### How are the original variables related to the principal components?

- Does not print small values, less impactful to correlation 

```{r}
#print out the loadings from the PCA object

```


- The loading are simple correlations between the principal components and the original variables (Pearson’s r).

- Values closest to 1 (positive) or -1 (negative) will represent the strongest relationships, with zero being uncorrelated.

We see in PC 1 that there is a high positive correlation between AvgSr. We see the correlation between solar radiation and the component direction is quite high. So by looking at the second component or the y-axis of our previous plot: we see for the most part, Leaf wetness correlated well with the occurance of rain.   


- Another visual to observe the impact of each variable on the principal component!  

- Not super pretty here

```{r}
#print a biplot from the PCA object


```

## Closing & Resources

- *Define* open data and reproducible science
- *Recognize* the importance of statistical analysis for climate data analysis using cloud based data
- *Apply* techniques to access and explore publicly available climate data from the cloud using exploratory data analysis
- *Create* a machine learning model to predicts results for a representative case study

\center
Any Questions? 
\center

### Resouces

- For a A Hydrologists Guide to Open Science, from the HESS Journal, click [here](https://hess.copernicus.org/articles/26/647/2022/). 

### Survey 

Thank you for attending the beginner track tutorial at the Open Climate Data Science Workshop. Please complete the voluntary feedback survey, linked [here](https://docs.google.com/forms/d/e/1FAIpQLSejTJjhvCLbCVKBotUa8VtDzYJBnMCilzPrB4VBzJrs7vXqIQ/viewform). The main purposes of this survey is to (1) determine we met specified teaching goals and (2) improve teaching materials for subsequent tutorial sessions.




