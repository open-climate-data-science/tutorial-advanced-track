---
title: "AdvTutorial"
author: "Nicholas Gawron & Livia Popa"
date: "1/28/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(tidyverse)
library(rnoaa)
library(forecast)
#install.packages("xts")                      # Install & load xts package
library("xts")
```

# Advanced Tutorial


## Importing Data From NCEI

Text on importing **with an API**.

```{r}
library(httr)
library(jsonlite)
base_url <- "https://www.ncdc.noaa.gov/cdo-web/api/v2/"
endpoint <- "datasets"
token <- "gykUMKPJzpcpQonBrUWjbFqYevOPkhwc"
full_url <- paste0(base_url, "/",endpoint,"/")
Raw  <- GET(full_url)

curl -H "token:gykUMKPJzpcpQonBrUWjbFqYevOPkhwc" "https://www.ncdc.noaa.gov/cdo-web/api/v2/datasets" $.ajax({ url:https://www.ncdc.noaa.gov/cdo-web/api/v2/datasets, data:{/datasets}, headers:{ token:gykUMKPJzpcpQonBrUWjbFqYevOPkhwc} })
```

## Machine Learning 

### Basic Plotting with Ggplot 

EDA is how we can motivate future ML models!

Text on *plotting*. 

### Content from beg. lecture

```{r}

cardinal <- read_csv("cardinal_data.csv", 
     col_types = list(`Average Air Temperature (F)` = col_number(), 
         `Maximum Air Temperature (F)` = col_number(), 
         `Minimum Air Temperature (F)` = col_number(), 
         `Average Experimental Leaf Wetness (mV)` = col_number(), 
         `Total Precipitation (in)` = col_number(), 
         `Average Relative Humidity (%)` = col_number(), 
         `Average Soil Moisture (m3/m3)` = col_number(), 
         `Average Soil Temperature (F)` = col_number(), 
         `Average Solar Radiation (W/m2)` = col_number(), 
         `Average Station Pressure (mb)` = col_number()))

cardinal<-drop_na(cardinal)
str(cardinal)
cardinal$Date<-as.Date(cardinal$Date, tryFormats= c("%m/%d/%y"))
view(cardinal)

#changes col names
colnames(cardinal)=c("date","AvgT","MaxT","MinT","AvgLw","Tprep","AvgHum","AvgSm","AvgSt","AvgSr","AvgStp")



cardinal$IfRain<- (cardinal$Tprep>0)
cardinal$IfRain<-as.factor(as.integer(cardinal$IfRain))


```

## Testing and training data

- 

### Logistic Regression ! TIme Series forecasting

```{r}
#logistic regression
fit1 = glm(IfRain~date, data=cardinal, family="binomial")
summary(fit1)

#predict something with logistic regression

```


```{r}

# n climate  grid data

temp_ts <- xts(cardinal$AvgT,cardinal$date)
temp_ts
  
autoplot(temp_ts[1:600])

half_temp <-temp_ts[1:600]

library(forecast)
d.arima <- auto.arima(half_temp)
d.forecast <- forecast(d.arima, level = c(90), h = 200)
autoplot(d.forecast)

```


### PCA to cluster rain variable 


```{r}
IfRainVar<- cardinal$IfRain
cardshort <- cardinal%>%select(-c(date,IfRain,Tprep,MinT,MaxT))
cardshort

pca_card<- princomp(scale(cardshort,scale=FALSE),cor = FALSE)


plot(pca_card$scores, pch = 16, col =IfRainVar)
legend("topright",c("No Rain","Rain"),pch=16,col=c("black","red"))

```


```{r}
summary(pca_card)
```


```{r}
screeplot(pca_card, type = "lines")
```


### How are the original variables related to the principal components?

```{r}
loadings(pca_card)
```


The loadings are simple correlations between the principal components and the original variables (Pearsonâ€™s r). Values closest to 1 (positive) or -1 (negative) will represent the strongest relationships, with zero being uncorrelated.

We see in PC 1 that there is a high positive correlation between AvgSr. We see the correlation between solar radiation and ...



```{r}
biplot(pca_card)
```



## Attempting to pull data from RNOAA  - not super successful rn


```{r}

options(noaakey = "TcAEMgEqaTjgGnnuyYbLXxmIJxiTPKuN")


#list of all stations
ghcnd_stations()

#tibble  of all stations given certain lattitude and logitudes
raliegh_stations<-ghcnd_stations()%>%dplyr::filter(latitude>34 & latitude<36 & longitude>-80 & longitude< -75)

 
raliegh_stations

real_ral<-ghcnd(stationid='GHCND:US1NCAL0013')
real_ral
```

```{r}
Ralz_dat <- ncdc(datasetid='GHCND', stationid='GHCND:US1NCAL0013', datatypeid=c('TAVG','PRCP'), startdate = '2011-01-01', enddate="2011-12-31", add_units = TRUE)

Ralz_dat

```

